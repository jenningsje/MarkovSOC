services:
  # -------------------------------
  # OpenSearch (CORE)
  # -------------------------------
  opensearch:
    image: opensearchproject/opensearch:2.11.1
    container_name: opensearch
    environment:
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g
      - plugins.security.disabled=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - opensearch_data:/usr/share/opensearch/data
    ports:
      - "9200:9200"
      - "9600:9600"

  # -------------------------------
  # OpenSearch Dashboards
  # -------------------------------
  opensearch-dashboards:
    image: opensearchproject/opensearch-dashboards@sha256:9b3d1d8d0d6c1d9a9d8c6a4a5e9f8b2d4f5c0d0c9b8a7e6d5c4b3a2f1e0
    container_name: dashboards
    environment:
      - OPENSEARCH_HOSTS=http://opensearch:9200
    ports:
      - "5601:5601"
    depends_on:
      - opensearch

  # -------------------------------
  # OpenSearch Index Init
  # -------------------------------
  opensearch-init:
    image: curlimages/curl:8.5.0
    container_name: opensearch-init
    depends_on:
      - opensearch
    entrypoint: >
      sh -c "
      sleep 20 &&
      curl -X PUT http://opensearch:9200/alerts &&
      curl -X PUT http://opensearch:9200/falco-logs &&
      curl -X PUT http://opensearch:9200/suricata-logs &&
      curl -X PUT http://opensearch:9200/zeek-logs
      "
    restart: "no"

  # -------------------------------
  # SpiderFoot (FIXED IMAGE)
  # -------------------------------
  spiderfoot:
    image: ghcr.io/spiderfoot/spiderfoot:latest
    container_name: spiderfoot
    environment:
      - SF_API_KEY=changeme123
    ports:
      - "5001:5001"

  # -------------------------------
  # SpiderFoot Enricher
  # -------------------------------
  sf-enricher:
    build:
      context: .
      dockerfile: Dockerfile.sf
    container_name: sf-enricher
    depends_on:
      - spiderfoot
      - opensearch
    environment:
      - SF_API_URL=http://spiderfoot:5001/api/v3
      - SF_API_KEY=changeme123
      - OS_HOST=opensearch
      - OS_PORT=9200
      - OS_INDEX=alerts
    volumes:
      - ./sf_enrich.py:/app/sf_enrich.py
      - ./sf_cache:/app/sf_cache
    command: >
      sh -c "while true; do python /app/sf_enrich.py; sleep 60; done"

  # -------------------------------
  # Falco (macOS-safe)
  # -------------------------------
  falco:
    image: falcosecurity/falco:0.38.0
    container_name: falco
    privileged: true
    volumes:
      - /var/run/docker.sock:/host/var/run/docker.sock
      - /proc:/host/proc:ro

  # -------------------------------
  # Suricata (PCAP mode)
  # -------------------------------
  suricata:
    image: jasonish/suricata:latest
    container_name: suricata
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_NICE
    volumes:
      - ./suricata-rules:/etc/suricata/rules
      - ./suricata-logs:/var/log/suricata
      - ./pcaps:/pcaps
    command: >
      suricata -r /pcaps/sample.pcap -l /var/log/suricata

  # -------------------------------
  # Zeek (PCAP replay)
  # -------------------------------
  zeek:
    image: zeek/zeek:8.0.5
    container_name: zeek
    volumes:
      - ./pcaps:/pcaps
      - ./zeek-logs:/zeek-logs
    command: >
      zeek -r /pcaps/sample.pcap local

volumes:
  opensearch_data:
  sf_cache:
